<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digimetric AI-Powered Content Idea Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Markdown Parser & Sanitizer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <!-- Load Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Black background */
            color: #e5e5f7;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 10vh;
            padding: 2rem 1rem;
        }
        .card {
            background-color: #2a2a4a;
            max-width: 900px;
            width: 100%;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .input-group {
            margin-bottom: 1.5rem;
        }
        .selector-label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            font-size: 1.125rem;
            color: #e5e5f7;
        }
        .selection-button {
            background-color: #3f3f6e;
            color: #e5e5f7;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            cursor: pointer;
            user-select: none;
            border: 2px solid transparent;
            font-size: 0.95rem;
            text-align: center;
        }
        .selection-button:hover:not(.selected) {
            background-color: #555588;
        }
        /* Default style for selected buttons (used by non-platform selectors) */
        .selection-button.selected { 
            background-color: #42A5F5; /* Light Blue (Standard Action Color) */
            color: #1a1a2e;
            font-weight: 600;
        }

        textarea, input[type="text"], input[type="password"] {
            background-color: #3f3f6e;
            border: 1px solid #555588;
            color: #e5e5f7;
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        textarea:focus, input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #42A5F5; /* Border color changed to the new Blue */
        }
        
        input.error {
            border-color: #EF4444 !important; /* Red color */
            border-width: 2px;
        }

        /* Base Generate Button Style (Green) */
        #generate-btn {
            background-color: #4CAF50; 
            color: #1a1a2e;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            width: 100%;
            transition: background-color 0.2s;
        }
        #generate-btn:hover {
            background-color: #388E3C; /* Darker Green on hover */
        }
        
        /* Save Button style (Green) */
        #save-api-key-btn {
            background-color: #4CAF50; 
            color: #1a1a2e;
            font-weight: 700;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-size: 1.25rem;
            transition: background-color 0.2s;
        }
        #save-api-key-btn:hover {
            background-color: #388E3C; /* Darker Green on hover */
        }


        /* Emoji Toggle Button Styles */
        #emoji-toggle-btn {
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
            border-radius: 0.75rem;
            height: 3.4rem; 
        }
        .toggle-off {
            background-color: #3f3f6e;
            color: #8888aa;
        }
        .toggle-off:hover {
            background-color: #555588;
        }
        /* Pink for ON state */
        .toggle-on {
            background-color: #EC4899; 
            color: #1a1a2e;
            font-weight: 700;
        }
        .toggle-on:hover {
            background-color: #DB2777; 
        }

        .action-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
            white-space: nowrap; 
        }
        .action-button#copy-btn, .action-button#copy-headline-btn, .action-button#copy-hashtag-btn {
            background-color: #555588 !important;
            color: #e5e5f7 !important;
        }
        .action-button#copy-btn:hover, .action-button#copy-headline-btn:hover, .action-button#copy-hashtag-btn:hover {
            background-color: #6a6a99 !important;
        }
        /* Regenerate to Orange */
        #regenerate-btn {
            background-color: #F97316; 
            color: #1a1a2e;
        }
        #regenerate-btn:hover {
            background-color: #EA580C; 
        }
        /* Headline to Green */
        #headline-btn {
            background-color: #4CAF50; 
            color: #1a1a2e;
        }
        #headline-btn:hover {
            background-color: #388E3C;
        }
        /* Hashtag button to Dark Blue */
        #hashtag-btn {
            background-color: #1D4ED8; 
            color: #FFFFFF;
        }
        #hashtag-btn:hover {
            background-color: #1E40AF; 
        }
        /* Reference Toggle Button Styles */
        #toggle-reference-btn {
            background-color: #4CAF50;
            color: #1a1a2e;
        }
        #toggle-reference-btn:hover {
            background-color: #388E3C;
        }
        #toggle-reference-btn.active {
            background-color: #dc2626; 
            color: #e5e5f7;
        }
        #toggle-reference-btn.active:hover {
            background-color: #b91c1c;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #42A5F5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Custom yellow text for dual hashtag output titles */
        .text-custom-yellow {
            color: #FCA311;
        }

        /* Ensure markdown output uses dark background colors for lists/blocks */
        #idea-output {
            line-height: 1.6;
        }
        #idea-output pre, #idea-output code {
            background-color: #1a1a2e;
            padding: 0.5rem;
            border-radius: 0.25rem;
            overflow-x: auto;
        }
        #idea-output ul {
            padding-left: 1.5rem;
            list-style-type: disc;
        }
        #idea-output ol {
            padding-left: 1.5rem;
            list-style-type: decimal;
        }
        
        /* Custom styling to place the eye icon for password input */
        .password-input-container {
            position: relative;
        }
        .toggle-password-visibility {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #8888aa; 
            padding: 0.25rem;
        }
        .toggle-password-visibility:hover {
            color: #e5e5f7;
        }
    </style>
</head>
<body>

<!-- API Key Modal -->
<div id="api-key-modal" class="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-50 p-4">
    <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-md">
        <div class="text-center mb-6">
            <p class="text-lg sm:text-xl font-medium text-gray-400">
                <span style="color: #4CAF50;">&#9999; Digimetric</span>
            </p>
            <h1 class="text-2xl sm:text-3xl font-bold mb-4">Content Idea Generator</h1>
            <h2 class="text-xl font-bold mb-4">Log in with Gemini API Key & Password</h2>
            <p class="text-gray-400 text-sm">Please enter your **Gemini API Key** and **Password** to use the application.</p>
        </div>

        <p class="text-xs text-gray-500 mt-4 text-center">Get your API Key for free at Google AI Studio.</p>

        <!-- API KEY INPUT -->
        <div class="input-group">
            <label for="api-key-input" class="selector-label text-base">Gemini API Key</label>
            <input type="password" id="api-key-input" placeholder="Enter API Key">
            <p id="api-key-error" class="text-red-400 text-sm mt-2 hidden"></p>
        </div>
        
        <!-- Password Input Field -->
        <div class="input-group">
            <label for="password-input-field" class="selector-label text-base">Password</label>
            <div class="password-input-container">
                <input type="password" id="password-input-field" placeholder="Enter Password">
                <span class="toggle-password-visibility" data-target="password-input-field" title="Show password">
                    <svg id="eye-slash-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.08-2.18M12 14a2 2 0 00-2 2M16 16a2 2 0 00-2-2M21.566 21.566l-1.414-1.414m-3.414-3.414L3.434 3.434m18.132 18.132L19.98 19.98M4.434 4.434L3.02 3.02M12 5c4.478 0 8.268 2.943 9.543 7a9.97 9.97 0 01-1.08 2.18M12 10a2 2 0 100 4 2 2 0 000-4z"></path>
                    </svg>
                    <svg id="eye-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                </span>
            </div>
        </div>

        <button id="save-api-key-btn" class="w-full font-bold py-3 px-4 rounded-lg">Log in</button>
    </div>
</div>

<div class="card p-6 lg:p-10 hidden">
    <!-- Title Structure -->
    <div class="text-center mb-8 relative">
        <p class="text-lg sm:text-xl font-medium text-gray-400">Digimetric</p>
        <h1 class="text-2xl sm:text-3xl font-bold">AI-Powered Content Idea Generator</h1>
        <button id="change-api-key-btn" class="absolute top-0 right-0 text-xs bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-2 rounded transition-colors">Change Key</button>
    </div>
    
    <!-- Input Section: Topic, Business Name, Audience -->
    <div class="grid grid-cols-1 gap-6 mb-6">
        <!-- Topic Input -->
        <div class="input-group">
            <label for="topic-input" class="selector-label">
                What topic do you need content ideas for?
            </label>
            <textarea id="topic-input" rows="3" placeholder="Enter your business type or specific content theme..." required></textarea>
        </div>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <!-- Business Name Input -->
            <div class="input-group mb-0">
                <label for="business-name-input" class="selector-label">
                    Whatâ€™s your Business/Shop Name?
                </label>
                <input id="business-name-input" type="text" placeholder="e.g., Starbucks, KFC, ZARA" />
            </div>
            
            <!-- Target Audience -->
            <div class="input-group mb-0">
                <label for="audience-input" class="selector-label">Target Audience (optional)</label>
                <input id="audience-input" type="text" placeholder="e.g., Business Owners, Entrepreneurs, Gen Z">
            </div>
        </div>
    </div>

    <!-- Configuration Grids -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">

        <!-- Platforms (Now Single Select with Brand Colors) -->
        <div class="input-group">
            <span class="selector-label">Platform</span>
            <div id="platform-selector" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <div class="selection-button" data-value="Facebook" data-type="single">Facebook</div>
                <div class="selection-button" data-value="Instagram" data-type="single">Instagram</div>
                <div class="selection-button" data-value="Twitter" data-type="single">Twitter/X</div>
                <div class="selection-button" data-value="YouTube" data-type="single">YouTube</div>
                <div class="selection-button" data-value="TikTok" data-type="single">TikTok</div>
                <div class="selection-button" data-value="LinkedIn" data-type="single">LinkedIn</div>
                <div class="selection-button" data-value="Website" data-type="single">Website</div>
            </div>
        </div>

        <!-- Content Types -->
        <div class="input-group">
            <span class="selector-label">Content Type</span>
            <div id="contentType-selector" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <div class="selection-button" data-value="Social Media Post" data-type="single">Social Media</div>
                <div class="selection-button selected" data-value="Blog Post" data-type="single">Blog Post</div> 
                <div class="selection-button" data-value="Podcast" data-type="single">Podcast</div>
                <div class="selection-button" data-value="Newsletter" data-type="single">Newsletter</div>
                <div class="selection-button" data-value="Infographic" data-type="single">Infographic</div>
                <div class="selection-button" data-value="Script/Outline" data-type="single">Script</div>
            </div>
        </div>
        
        <!-- Choose Output Level -->
        <div class="input-group">
            <span class="selector-label">Choose Output Level</span>
            <div id="outputLevel-selector" class="flex gap-3">
                <div class="selection-button" data-value="Rough" data-type="single">Rough Idea</div>
                <div class="selection-button selected" data-value="Short" data-type="single">Short to the point</div>
                <div class="selection-button" data-value="Detailed" data-type="single">Detailed with Info</div>
            </div>
        </div>

        <!-- Select Language -->
        <div class="input-group">
            <span class="selector-label">Select Language</span>
            <div id="language-selector" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <div class="selection-button selected" data-value="English" data-type="single">English</div>
                <div class="selection-button" data-value="Myanmar (Burmese)" data-type="single">Myanmar</div> 
                <div class="selection-button" data-value="Thai" data-type="single">Thailand</div>
                <div class="selection-button" data-value="Chinese" data-type="single">Chinese</div>
                <div class="selection-button" data-value="Tagalog (Philippine)" data-type="single">Philippine</div>
                <div class="selection-button" data-value="Indonesian" data-type="single">Indonesia</div>
            </div>
        </div>

        <!-- Tone/Style -->
        <div class="input-group md:col-span-2">
            <span class="selector-label">Tone/Style</span>
            <div id="tone-selector" class="grid grid-cols-3 sm:grid-cols-7 gap-3">
                <div class="selection-button" data-value="Sales" data-type="single">Sales</div> 
                <div class="selection-button" data-value="Professional" data-type="single">Professional</div>
                <div class="selection-button" data-value="Motivational" data-type="single">Motivational</div>
                <div class="selection-button" data-value="Informational" data-type="single">Informational</div>
                <div class="selection-button selected" data-value="Emotional" data-type="single">Emotional</div> 
                <div class="selection-button" data-value="Storytelling" data-type="single">Storytelling</div>
                <div class="selection-button" data-value="Business Perspective" data-type="single">Business Perspective</div>
            </div>
        </div>

    </div>
    
    <!-- Reference URL Input Area -->
    <div class="mt-6 input-group">
        <div class="flex justify-between items-center mb-3">
            <span class="selector-label mb-0">Reference URLs (optional)</span>
            <button id="toggle-reference-btn" class="action-button">
                + Add Reference URL
            </button>
        </div>
        <div id="reference-url-container" class="hidden">
            <textarea id="reference-url-input" rows="3" placeholder="Paste one or more reference links here, separated by newlines or commas. The AI will use this information as context."></textarea>
            <p class="text-xs text-gray-400 mt-2">The AI will read the content of these links for context, in addition to using Google Search.</p>
        </div>
    </div>


    <!-- Generate Button and Emoji Toggle -->
    <div class="mt-8 flex gap-4 items-stretch">
        <button id="generate-btn" class="flex-grow">
            Generate Ideas
        </button>
        <!-- Emoji Toggle Button -->
        <button id="emoji-toggle-btn" 
                class="flex-shrink-0 w-16 text-2xl flex items-center justify-center toggle-off" 
                title="Emoji Off">
            ðŸš«
        </button>
    </div>

    <!-- Results Container (Main Idea) -->
    <div id="results-container" class="hidden mt-8">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
            <h2 id="idea-title" class="text-xl font-semibold flex-shrink-0">Generated Content Idea</h2>
            <!-- Action Buttons for Idea (Copy and Regenerate) -->
            <div class="flex flex-wrap justify-start sm:justify-end gap-3 w-full sm:w-auto">
                <button id="copy-btn" class="action-button hidden">
                    Copy
                </button>
                <button id="regenerate-btn" class="action-button hidden">
                    Regenerate Idea
                </button>
            </div>
        </div>
        
        <div id="loading-indicator" class="flex justify-center items-center py-8 hidden">
            <div class="spinner mr-3"></div>
            <span class="text-lg">Generating Content Idea...</span>
        </div>
        <div id="idea-output" class="text-sm whitespace-pre-wrap"></div>
        <!-- Source Output Container - Hide entirely if no sources are found -->
        <div id="sources-output" class="mt-4 pt-4 border-t border-gray-600 border-dashed text-xs text-gray-400 hidden"></div>
        
        <!-- Secondary Action Buttons -->
        <div class="mt-6 pt-4 border-t border-gray-600 border-dashed flex flex-col sm:flex-row flex-wrap items-center justify-center gap-4">
            <button id="headline-btn" class="action-button hidden w-full sm:w-auto">
                Generate Headline Ideas
            </button>
            <button id="hashtag-btn" class="action-button hidden w-full sm:w-auto">
                Trending Hashtag Ideas
            </button>
        </div>
    </div>
    
    <!-- Headline Results Container -->
    <div id="headline-results-container" class="hidden mt-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Generated Headline Ideas</h2>
            <button id="copy-headline-btn" class="action-button hidden">
                Copy
            </button>
        </div>
        <div id="headline-loading-indicator" class="flex justify-center items-center py-8 hidden">
            <div class="spinner mr-3"></div>
            <span class="text-lg">Generating Headlines...</span>
        </div>
        <div id="headline-output" class="text-sm whitespace-pre-wrap"></div>
    </div>

    <!-- Hashtag Results Container (Updated for Dual Output) -->
    <div id="hashtag-results-container" class="hidden mt-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Trending Hashtag Ideas</h2>
            <button id="copy-hashtag-btn" class="action-button hidden">
                Copy
            </button>
        </div>
        <div id="hashtag-loading-indicator" class="flex justify-center items-center py-8 hidden">
            <div class="spinner mr-3"></div>
            <span class="text-lg">Generating Trending Hashtags...</span>
        </div>
        
        <!-- DUAL LANGUAGE OUTPUT BOXES (For Myanmar Language) -->
        <div id="dual-hashtag-output" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
            <div>
                <h3 class="font-bold text-lg text-custom-yellow mb-2">English Hashtags</h3>
                <div id="hashtag-output-en" class="text-sm whitespace-pre-wrap p-4 bg-gray-700 rounded-lg"></div>
            </div>
            <div>
                <h3 class="font-bold text-lg text-custom-yellow mb-2">Myanmar Hashtags</h3>
                <div id="hashtag-output-mm" class="text-sm whitespace-pre-wrap p-4 bg-gray-700 rounded-lg"></div>
            </div>
        </div>
        
        <!-- SINGLE LANGUAGE OUTPUT BOX (Default) -->
        <div id="single-hashtag-output">
            <div id="hashtag-output" class="text-sm whitespace-pre-wrap"></div>
        </div>
    </div>
</div>

<script>
    // --- Helper Functions and Initial Setup ---

    // Global State for Emoji Toggle
    let isEmojiEnabled = false; 

    // Utility for exponential backoff during API calls
    const MAX_RETRIES = 7;
    const initialDelay = 1000;
    
    // Model: gemini-2.5-flash-preview-05-20 for stability and speed.
    const modelName = 'gemini-2.5-flash-preview-05-20'; 

    // Global variable to store the last generated content idea for secondary generation
    let lastGeneratedContentIdea = "";
    
    // --- Password Validation Logic ---
    function checkPasswordRange(password) {
        if (!password) return false;
        const regex = /^digicig(\d{4})$/;
        const match = password.match(regex);
        if (!match) return false;
        const minPass = "digicig0251";
        const maxPass = "digicig0800";
        return password >= minPass && password <= maxPass;
    }

    // --- Password Visibility Toggle Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.toggle-password-visibility').forEach(toggle => {
            const eyeIcon = toggle.querySelector('#eye-icon');
            const eyeSlashIcon = toggle.querySelector('#eye-slash-icon');
            const targetInput = document.getElementById(toggle.dataset.target);

            // Set initial state based on input type
            if (targetInput.type === 'password') {
                eyeIcon.classList.add('hidden');
                eyeSlashIcon.classList.remove('hidden');
                toggle.title = 'Show password';
            } else {
                eyeIcon.classList.remove('hidden');
                eyeSlashIcon.classList.add('hidden');
                toggle.title = 'Hide password';
            }

            toggle.addEventListener('click', (event) => {
                const targetId = event.currentTarget.dataset.target;
                const targetInput = document.getElementById(targetId);
                
                if (targetInput.type === 'password') {
                    targetInput.type = 'text';
                    eyeSlashIcon.classList.add('hidden');
                    eyeIcon.classList.remove('hidden');
                    event.currentTarget.title = 'Hide password';
                } else {
                    targetInput.type = 'password';
                    eyeIcon.classList.add('hidden');
                    eyeSlashIcon.classList.remove('hidden');
                    event.currentTarget.title = 'Show password';
                }
            });
        });
    });

    // --- API Key Management & Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        const apiKeyModal = document.getElementById('api-key-modal');
        const mainCard = document.querySelector('.card');
        const apiKeyInput = document.getElementById('api-key-input');
        const passwordInputField = document.getElementById('password-input-field'); 
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const changeApiKeyBtn = document.getElementById('change-api-key-btn');
        const apiKeyError = document.getElementById('api-key-error');

        function initializeApp() {
            const userApiKey = localStorage.getItem('geminiApiKey');
            const userPassword = localStorage.getItem('appPassword'); 
            
            if (userApiKey && userPassword) { 
                apiKeyModal.classList.add('hidden');
                mainCard.classList.remove('hidden');
            } else {
                apiKeyModal.classList.remove('hidden');
                mainCard.classList.add('hidden');
            }
        }

        saveApiKeyBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            const password = passwordInputField.value.trim(); 
            
            apiKeyInput.classList.remove('error');
            passwordInputField.classList.remove('error');
            apiKeyError.classList.add('hidden'); 

            let isValid = true;

            if (!key || key.length <= 10) {
                apiKeyError.textContent = 'API Key is required. (Please enter a valid API key.)';
                apiKeyError.classList.remove('hidden');
                apiKeyInput.classList.add('error');
                isValid = false;
            } 
            
            if (!password || !checkPasswordRange(password)) {
                passwordInputField.classList.add('error');
                isValid = false;
            }
            
            if (!isValid) {
                return;
            }

            localStorage.setItem('geminiApiKey', key);
            localStorage.setItem('appPassword', password); 
            initializeApp();
        });

        changeApiKeyBtn.addEventListener('click', () => {
            localStorage.removeItem('geminiApiKey');
            localStorage.removeItem('appPassword'); 
            apiKeyInput.value = ''; 
            passwordInputField.value = '';
            apiKeyInput.classList.remove('error');
            passwordInputField.classList.remove('error');
            initializeApp();
        });
        
        // Initial check on page load
        initializeApp();
    });

    /**
     * Converts a markdown list of sources to an HTML string.
     */
    function formatSources(sources) {
        if (!sources || sources.length === 0) return '';

        let html = '<strong>Up-to-date Information Sources:</strong><ul>';
        sources.forEach(source => {
            html += `<li><a href="${source.uri}" target="_blank" class="text-blue-400 hover:text-blue-300 transition">${source.title || source.uri}</a></li>`;
        });
        html += '</ul>';
        return html;
    }

    /**
     * Calls the Gemini API with exponential backoff.
     */
    async function callGeminiApi(payload, retries = 0) {
        const userApiKey = localStorage.getItem('geminiApiKey');
        if (!userApiKey) {
            throw new Error("Gemini API Key not found. Please set your key.");
        }
        const apiKey = userApiKey; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

        if (retries >= MAX_RETRIES) {
            throw new Error("API call failed after reaching maximum retries. This might be due to temporary server load or a network issue.");
        }

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                if (response.status === 429 || response.status >= 500) {
                    const delay = initialDelay * Math.pow(2, retries);
                    console.warn(`Attempt ${retries + 1} failed with status ${response.status}. Retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return callGeminiApi(payload, retries + 1);
                }
                const errorBody = await response.text();
                console.error("Gemini API Error Response:", errorBody); 
                throw new Error(`API returned status ${response.status}: ${errorBody}`);
            }

            return await response.json();
        } catch (error) {
            if (retries < MAX_RETRIES) {
                const delay = initialDelay * Math.pow(2, retries);
                console.warn(`Network error on attempt ${retries + 1}. Retrying in ${delay}ms...`, error);
                await new Promise(resolve => setTimeout(resolve, delay));
                return callGeminiApi(payload, retries + 1);
            }
            throw error;
        }
    }


    // --- UI Logic: Toggling Selection Buttons & Input Gathering ---

    // Define platform brand colors for selection styling
    const platformColors = {
        "Facebook": { bg: "#1877F2", text: "#FFFFFF", border: "transparent" }, // Facebook Blue
        "Instagram": { bg: "#9966CC", text: "#FFFFFF", border: "transparent" }, // Light Purple
        "Twitter": { bg: "#6B7280", text: "#FFFFFF", border: "transparent" }, // Grey
        "YouTube": { bg: "#FF0000", text: "#FFFFFF", border: "transparent" }, // YouTube Red
        "TikTok": { bg: "#000000", text: "#E5E5F7", border: "#E5E5F7" }, // Black
        "LinkedIn": { bg: "#0A66C2", text: "#FFFFFF", border: "transparent" }, // LinkedIn Blue
        "Website": { bg: "#4CAF50", text: "#1a1a2e", border: "#4CAF50" } // Green
    };
    
    // Platform selector logic (handles dynamic colors)
    const platformSelector = document.getElementById('platform-selector');
    
    platformSelector.addEventListener('click', (event) => {
        const button = event.target.closest('.selection-button');
        if (!button || !platformSelector.contains(button)) return;

        platformSelector.querySelectorAll('.selection-button').forEach(btn => {
            btn.classList.remove('selected');
            btn.style.backgroundColor = '';
            btn.style.color = '';
            btn.style.border = '2px solid transparent';
            btn.style.fontWeight = '400'; 
        });

        button.classList.add('selected');
        const platform = button.dataset.value;
        const color = platformColors[platform];
        if (color) {
            button.style.backgroundColor = color.bg;
            button.style.color = color.text;
            button.style.border = `2px solid ${color.border}`;
            button.style.fontWeight = '600';
        } else {
            button.style.backgroundColor = '#42A5F5';
            button.style.color = '#1a1a2e';
            button.style.fontWeight = '600';
        }
    });

    // Other selectors (standard blue selection)
    const selectors = ['contentType', 'outputLevel', 'language', 'tone'];
    
    selectors.forEach(id => {
        const container = document.getElementById(`${id}-selector`);
        if (container) {
            container.addEventListener('click', (event) => {
                const button = event.target.closest('.selection-button');
                if (!button || !container.contains(button)) return;

                const type = button.dataset.type;

                if (type === 'single') {
                    container.querySelectorAll('.selection-button').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    button.classList.add('selected');
                } else if (type === 'multi') {
                    button.classList.toggle('selected');
                }
            });
        }
    });

    /**
     * Gathers all selected values from a selector container.
     */
    function getSelectedValues(id) {
        const container = document.getElementById(`${id}-selector`);
        if (!container) return '';
        
        const selectedButtons = container.querySelectorAll('.selection-button.selected');
        
        return Array.from(selectedButtons)
                    .map(btn => btn.dataset.value)
                    .join(', ');
    }

    // --- Emoji Toggle Logic ---
    const emojiToggleBtn = document.getElementById('emoji-toggle-btn');
    
    emojiToggleBtn.classList.add('toggle-off');

    emojiToggleBtn.addEventListener('click', () => {
        isEmojiEnabled = !isEmojiEnabled;
        if (isEmojiEnabled) {
            emojiToggleBtn.textContent = 'ðŸ˜Š';
            emojiToggleBtn.classList.remove('toggle-off');
            emojiToggleBtn.classList.add('toggle-on');
            emojiToggleBtn.title = 'Emoji On';
        } else {
            emojiToggleBtn.textContent = 'ðŸš«';
            emojiToggleBtn.classList.remove('toggle-on');
            emojiToggleBtn.classList.add('toggle-off');
            emojiToggleBtn.title = 'Emoji Off';
        }
    });
    
    // --- Reference URL Toggle Logic ---
    const toggleReferenceBtn = document.getElementById('toggle-reference-btn');
    const referenceUrlContainer = document.getElementById('reference-url-container');
    const referenceUrlInput = document.getElementById('reference-url-input');
    let isUrlInputVisible = false;

    toggleReferenceBtn.textContent = '+ Add Reference URL';

    toggleReferenceBtn.addEventListener('click', () => {
        isUrlInputVisible = !isUrlInputVisible;
        referenceUrlContainer.classList.toggle('hidden', !isUrlInputVisible);
        
        if (isUrlInputVisible) {
            toggleReferenceBtn.textContent = '- Hide Reference URL';
            toggleReferenceBtn.classList.add('active');
        } else {
            toggleReferenceBtn.textContent = '+ Add Reference URL';
            toggleReferenceBtn.classList.remove('active');
        }
    });

    // --- Copy Functionality (FIXED FOR iFRAME COMPATIBILITY) ---
    const copyBtn = document.getElementById('copy-btn');
    const ideaOutput = document.getElementById('idea-output');
    const regenerateBtn = document.getElementById('regenerate-btn');
    const headlineBtn = document.getElementById('headline-btn');
    const hashtagBtn = document.getElementById('hashtag-btn');

    const headlineOutput = document.getElementById('headline-output');
    const headlineResultsContainer = document.getElementById('headline-results-container');
    const copyHeadlineBtn = document.getElementById('copy-headline-btn');

    const hashtagOutput = document.getElementById('hashtag-output');
    const hashtagOutputEn = document.getElementById('hashtag-output-en');
    const hashtagOutputMm = document.getElementById('hashtag-output-mm');
    const hashtagResultsContainer = document.getElementById('hashtag-results-container');
    const copyHashtagBtn = document.getElementById('copy-hashtag-btn');


    /**
     * Reusable copy logic for any element/object, using document.execCommand for iFrame compatibility.
     * @param {HTMLElement | {text: string}} targetElement - The element or object containing the text content to copy.
     * @param {HTMLElement} buttonElement - The button element for visual feedback.
     */
    async function copyContent(targetElement, buttonElement) {
        const rawText = targetElement.textContent || (targetElement.text || '');
        const textToCopy = rawText.trim(); 
        
        if (!textToCopy) return;

        const originalText = buttonElement.textContent;
        const originalBg = buttonElement.style.backgroundColor;
        const originalColor = buttonElement.style.color;
        const successBg = '#10B981'; // Emerald Green
        const successColor = '#1a1a2e';
        
        let success = false;
        const textarea = document.createElement('textarea');
        textarea.value = textToCopy;
        textarea.style.position = 'fixed';
        textarea.style.top = '0';
        textarea.style.left = '0';
        textarea.style.opacity = '0';
        
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();

        try {
            success = document.execCommand('copy');
        } catch (err) {
            console.error('Copy failed:', err);
            success = false;
        } finally {
            document.body.removeChild(textarea);
        }

        if (success) {
            buttonElement.textContent = 'Copied! ðŸŽ‰';
            buttonElement.style.backgroundColor = successBg;
            buttonElement.style.color = successColor;
            
            setTimeout(() => {
                buttonElement.textContent = originalText;
                buttonElement.style.backgroundColor = originalBg;
                buttonElement.style.color = originalColor;
            }, 2000);
        } else {
            buttonElement.textContent = 'Failed!';
            buttonElement.style.backgroundColor = '#DC2626';
            buttonElement.style.color = '#FFFFFF';
            setTimeout(() => {
                buttonElement.textContent = originalText;
                buttonElement.style.backgroundColor = originalBg;
                buttonElement.style.color = originalColor;
            }, 1000);
        }
    }


    // --- Main Generator Function ---
    async function generateContentIdea(regenerate = false) {
        const topic = document.getElementById('topic-input').value.trim();
        const businessName = document.getElementById('business-name-input').value.trim(); 
        
        if (!topic) {
            console.error("Please enter a content topic or business type."); 
            return;
        }

        // Reset previous results
        document.getElementById('idea-output').innerHTML = '';
        document.getElementById('sources-output').innerHTML = '';
        document.getElementById('results-container').classList.remove('hidden');
        document.getElementById('headline-results-container').classList.add('hidden');
        document.getElementById('hashtag-results-container').classList.add('hidden');
        document.getElementById('loading-indicator').classList.remove('hidden');
        document.getElementById('generate-btn').disabled = true;
        document.getElementById('generate-btn').innerHTML = '<div class="spinner mx-auto"></div>';

        // Hide action buttons initially
        copyBtn.classList.add('hidden');
        regenerateBtn.classList.add('hidden');
        headlineBtn.classList.add('hidden');
        hashtagBtn.classList.add('hidden');


        // Gather input parameters
        const platform = getSelectedValues('platform');
        const contentType = getSelectedValues('contentType');
        const outputLevel = getSelectedValues('outputLevel');
        const language = getSelectedValues('language');
        const tone = getSelectedValues('tone'); 
        const audience = document.getElementById('audience-input').value.trim();
        const referenceUrls = referenceUrlInput.value.trim().split(/[\n,;]+/).map(url => url.trim()).filter(url => url.length > 0);

        let wordLimit = 300; 
        if (outputLevel === 'Rough') {
            wordLimit = 150; 
        } else if (outputLevel === 'Detailed') {
            wordLimit = 500; 
        }
        
        let specificToneDescription = tone;
        switch(tone) {
            case 'Sales':
                specificToneDescription = "a persuasive, action-oriented, and clear sales style, focused on achieving a direct objective.";
                break;
            case 'Professional':
                specificToneDescription = "a formal, well-structured, and clear style, suitable for corporate or detailed analytical content.";
                break;
            case 'Motivational':
                specificToneDescription = "an encouraging and positive style, aimed at inspiring the audience and driving confident action.";
                break;
            case 'Informational':
                specificToneDescription = "a neutral, objective, and educational style, focusing on delivering facts and knowledge clearly.";
                break;
            case 'Emotional':
                specificToneDescription = "a deeply connecting and empathetic style that focuses on audience feelings and shared experiences."; 
                break;
            case 'Storytelling':
                specificToneDescription = "a narrative style that uses characters, sequence, and experience to convey the core idea.";
                break;
            case 'Business Perspective':
                specificToneDescription = "a clear, objective, and analytical style that focuses on strategy, trends, and commercial value.";
                break;
            default:
                specificToneDescription = "a neutral and informative tone";
        }
        
        // System Instruction Construction
        const systemPromptParts = [
            `You are Digimetric AI, a world-class content strategist and copywriter.`,
            `Your task is to generate a single, compelling content idea based on the user's brief.`,
            `You MUST NOT include a separate Title or Headline section within the main content output.`,
            `The output should be formatted using **Markdown** (with bolding, lists, and headings) for readability.`,
            `You MUST NOT use separator lines or characters such as '---', '***', or '$$$' at the beginning or end of the content.`,
            `The response length MUST be approximately ${wordLimit} words. Do NOT exceed this limit.`, 
            `Do NOT include introductory or concluding remarks.`,
            `Maintain the following Tone/Style: ${specificToneDescription}.`, 
            `The output level is: ${outputLevel}.`,
            `Deliver the output strictly in the requested language: ${language}.`,
        ];
        
        if (isEmojiEnabled) {
            systemPromptParts.push(`MUST use relevant emojis liberally to make the content lively and engaging.`);
        } else {
            systemPromptParts.push(`MUST NOT use any emojis in the output.`);
        }
        
        if (language === 'Myanmar (Burmese)') {
            systemPromptParts.push(`For any sentences ending with the Burmese question words "á€œá€¬á€¸" or "á€œá€²", you MUST append a question mark (?) immediately after the word, e.g., "á€œá€¯á€•á€ºá€™á€œá€¬á€¸?" or "á€žá€½á€¬á€¸á€™á€œá€²?".`);
        }


        // User Query Construction
        const userQueryParts = [
            `Generate a content idea for the following brief:`,
            `- **Topic/Business**: ${topic}`,
        ];
        
        // Add Business Name to User Query if provided
        if (businessName) {
            userQueryParts.push(`- **Business/Shop Name to reference**: ${businessName}`);
        }
        
        userQueryParts.push(
            `- **Platform**: ${platform || 'General Content Platform'}`,
            `- **Content Type**: ${contentType}`,
        );

        if (audience) {
            userQueryParts.push(`- **Target Audience**: ${audience}`);
        }
        if (referenceUrls.length > 0) {
            userQueryParts.push(`- **Reference Context URLs (read and summarize key info)**: ${referenceUrls.join(', ')}`);
        }

        const systemInstruction = systemPromptParts.join(' ');
        const userQuery = userQueryParts.join('\n');

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            tools: [{ "google_search": {} }],
            systemInstruction: {
                parts: [{ text: systemInstruction }]
            },
        };

        try {
            const result = await callGeminiApi(payload);
            const candidate = result.candidates?.[0];
            let rawText = "Error: Received an empty or unexpected response from the AI. This may happen if the combination of Topic, Tone, and Language is too specific or restrictive for the AI to generate a valid response. Please try simplifying your input or choose a different Tone/Style.";
            let sources = [];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                rawText = candidate.content.parts[0].text;
                lastGeneratedContentIdea = rawText;

                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                const renderedHtml = DOMPurify.sanitize(marked.parse(rawText));
                ideaOutput.innerHTML = renderedHtml;

                if (sources.length > 0) {
                    document.getElementById('sources-output').innerHTML = formatSources(sources);
                    document.getElementById('sources-output').classList.remove('hidden');
                } else {
                    document.getElementById('sources-output').classList.add('hidden');
                }

                copyBtn.classList.remove('hidden');
                regenerateBtn.classList.remove('hidden');
                headlineBtn.classList.remove('hidden');
                hashtagBtn.classList.remove('hidden');

            } else {
                ideaOutput.innerHTML = `<p class="text-red-400">Error: Received an empty or unexpected response from the AI. This may happen if the combination of Topic, Tone, and Language is too specific or restrictive for the AI to generate a valid response. Please try simplifying your input or choose a different Tone/Style.</p>`;
            }

        } catch (error) {
            console.error("Content Generation Error:", error);
            ideaOutput.innerHTML = `<p class="text-red-400">An API error occurred: ${error.message || 'Check console for details.'}</p>`;
        } finally {
            document.getElementById('loading-indicator').classList.add('hidden');
            document.getElementById('generate-btn').disabled = false;
            document.getElementById('generate-btn').textContent = regenerate ? 'Regenerate Idea' : 'Generate Ideas';
        }
    }


    // --- Secondary Generator Function (Headlines & Hashtags) ---
    async function generateSecondaryContent(type) {
        if (!lastGeneratedContentIdea) {
            console.error("Please generate a main content idea first.");
            return;
        }

        const isHeadline = type === 'headline';
        const isHashtag = type === 'hashtag';
        const language = getSelectedValues('language');
        const isMyanmar = language === 'Myanmar (Burmese)';

        const resultsContainer = isHeadline ? headlineResultsContainer : hashtagResultsContainer;
        const outputElement = isHeadline ? headlineOutput : hashtagOutput;
        const loadingIndicator = isHeadline ? document.getElementById('headline-loading-indicator') : document.getElementById('hashtag-loading-indicator');
        const copyButton = isHeadline ? copyHeadlineBtn : copyHashtagBtn;
        
        const singleHashtagContainer = document.getElementById('single-hashtag-output');
        const dualHashtagContainer = document.getElementById('dual-hashtag-output');
        
        // Setup UI
        resultsContainer.classList.remove('hidden');
        loadingIndicator.classList.remove('hidden');
        outputElement.innerHTML = '';
        copyButton.classList.add('hidden');
        if (isHashtag) {
            singleHashtagContainer.classList.remove('hidden');
            dualHashtagContainer.classList.add('hidden');
            hashtagOutputEn.textContent = '';
            hashtagOutputMm.textContent = '';
        }

        let systemInstruction;
        let userQuery;
        
        let questionMarkInstruction = "";
        if (isHeadline && isMyanmar) {
             questionMarkInstruction = `For any headline ending with the Burmese question words "á€œá€¬á€¸" or "á€œá€²", you MUST append a question mark (?) immediately after the word, e.g., "á€˜á€¬á€€á€¼á€±á€¬á€„á€·á€ºá€’á€®á€œá€­á€¯á€–á€¼á€…á€ºá€á€¬á€œá€²?".`;
        }
        
        const separatorInstruction = `You MUST NOT use separator lines or characters such as '---', '***', '***', or '$$$' at the beginning or end of the content.`;


        if (isHeadline) {
            systemInstruction = `You are a professional copywriter. Your task is to create 10 highly engaging and clickable headlines (titles) for the following content idea. The headlines should be formatted as a numbered list in Markdown. Deliver the output strictly in the requested language: ${language}. ${isEmojiEnabled ? 'Use emojis.' : 'Do NOT use emojis.'} ${questionMarkInstruction} ${separatorInstruction}`;
            userQuery = `Content Idea to generate headlines for:\n\n---\n${lastGeneratedContentIdea}`;
        } else if (isHashtag) {
            if (isMyanmar) {
                systemInstruction = `You are a social media trend expert. Your task is to generate trending and relevant hashtags for the following content idea. You MUST provide TWO distinct lists: one for English hashtags and one for Myanmar (Burmese) hashtags. Format the output strictly as follows: 
                ENGLISH_HASHTAGS: #hashtag1 #hashtag2 #hashtag3...
                MYANMAR_HASHTAGS: #á€™á€¼á€”á€ºá€™á€¬tag1 #á€™á€¼á€”á€ºá€™á€¬tag2 #á€™á€¼á€”á€ºá€™á€¬tag3...
                DO NOT include any other text, explanation, or introduction besides the two sections and the hashtags themselves. ${separatorInstruction}`;
                userQuery = `Content Idea to generate trending hashtags for:\n\n---\n${lastGeneratedContentIdea}`;
            } else {
                systemInstruction = `You are a social media trend expert. Your task is to generate 20 trending and highly relevant hashtags for the following content idea. The hashtags must be delivered strictly in the requested language: ${language}. The output MUST be a single line of text with all hashtags separated by a space, beginning with the '#' symbol for each tag. DO NOT include any lists, numbers, or other text. ${separatorInstruction}`;
                userQuery = `Content Idea to generate trending hashtags for:\n\n---\n${lastGeneratedContentIdea}`;
            }
        }

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            tools: [{ "google_search": {} }],
            systemInstruction: {
                parts: [{ text: systemInstruction }]
            },
        };

        try {
            const result = await callGeminiApi(payload);
            const rawText = result.candidates?.[0]?.content?.parts?.[0]?.text || '';
            
            if (!rawText) {
                outputElement.textContent = `Error: Received an empty response from the AI for ${type}.`;
                return;
            }

            if (isHashtag && isMyanmar) {
                // Handle Dual Hashtag Output
                const enMatch = rawText.match(/ENGLISH_HASHTAGS\s*:\s*([\s\S]*?)(?:\r?\n|\r)MYANMAR_HASHTAGS/i);
                const mmMatch = rawText.match(/MYANMAR_HASHTAGS\s*:\s*([\s\S]*)/i);

                let enHashtags = 'Could not parse English hashtags.';
                let mmHashtags = 'Could not parse Myanmar hashtags.';

                if (enMatch && enMatch[1]) {
                    enHashtags = enMatch[1].trim();
                }
                if (mmMatch && mmMatch[1]) {
                    mmHashtags = mmMatch[1].trim();
                }

                if (enMatch || mmMatch) {
                    hashtagOutputEn.textContent = enHashtags;
                    hashtagOutputMm.textContent = mmHashtags;
                    singleHashtagContainer.classList.add('hidden');
                    dualHashtagContainer.classList.remove('hidden');
                    copyButton.classList.remove('hidden');
                } else {
                    outputElement.innerHTML = `<p class="text-red-400">Error parsing dual language output. Displaying raw response for debugging: <pre>${rawText}</pre></p>`;
                    singleHashtagContainer.classList.remove('hidden');
                    dualHashtagContainer.classList.add('hidden');
                    copyButton.classList.remove('hidden');
                }

            } else {
                // Handle Single Output (Headlines or non-Myanmar Hashtags)
                const renderedHtml = DOMPurify.sanitize(marked.parse(rawText));
                outputElement.innerHTML = renderedHtml;
                singleHashtagContainer.classList.remove('hidden');
                copyButton.classList.remove('hidden');
            }

        } catch (error) {
            console.error(`${type} Generation Error:`, error);
            outputElement.innerHTML = `<p class="text-red-400">An error occurred during ${type} generation: ${error.message || 'Check console for details.'}</p>`;
        } finally {
            loadingIndicator.classList.add('hidden');
        }
    }


    // --- Event Listeners ---

    // Primary Generation
    document.getElementById('generate-btn').addEventListener('click', () => generateContentIdea(false));
    regenerateBtn.addEventListener('click', () => generateContentIdea(true));

    // Secondary Generation
    headlineBtn.addEventListener('click', () => generateSecondaryContent('headline'));
    hashtagBtn.addEventListener('click', () => generateSecondaryContent('hashtag'));

    // Copy Main Idea
    copyBtn.addEventListener('click', () => {
        copyContent({ text: lastGeneratedContentIdea }, copyBtn);
    });

    // Copy Headline
    copyHeadlineBtn.addEventListener('click', () => {
        copyContent(headlineOutput, copyHeadlineBtn);
    });
    
    // Copy Hashtags (Handles dual language structure)
    copyHashtagBtn.addEventListener('click', () => {
        const selectedLanguage = getSelectedValues('language');
        let textToCopy;
        
        if (selectedLanguage === 'Myanmar (Burmese)') {
            const enText = hashtagOutputEn.textContent.trim();
            const mmText = hashtagOutputMm.textContent.trim();
            textToCopy = `${enText}\n${mmText}`;
        } else {
            textToCopy = hashtagOutput.textContent.trim();
        }

        copyContent({ text: textToCopy }, copyHashtagBtn);
    });

</script>
</body>
</html>
