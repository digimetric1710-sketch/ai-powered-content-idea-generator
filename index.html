<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digimetric AI-Powered Content Idea Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Markdown Parser & Sanitizer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <!-- Load Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* CHANGED: Black background */
            color: #e5e5f7;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 10vh;
            padding: 2rem 1rem;
        }
        .card {
            background-color: #2a2a4a;
            max-width: 900px;
            width: 100%;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .input-group {
            margin-bottom: 1.5rem;
        }
        .selector-label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            font-size: 1.125rem;
            color: #e5e5f7;
        }
        .selection-button {
            background-color: #3f3f6e;
            color: #e5e5f7;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            cursor: pointer;
            user-select: none;
            border: 2px solid transparent;
            font-size: 0.95rem;
            text-align: center;
        }
        .selection-button:hover:not(.selected) {
            background-color: #555588;
        }
        /* Default style for selected buttons (used by non-platform selectors) */
        .selection-button.selected { 
            background-color: #42A5F5; /* Light Blue (Standard Action Color) */
            color: #1a1a2e;
            font-weight: 600;
        }
        /* Platform buttons will override the background-color and color using inline styles in JS */

        textarea, input[type="text"], input[type="password"] {
            background-color: #3f3f6e;
            border: 1px solid #555588;
            color: #e5e5f7;
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        textarea:focus, input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #42A5F5; /* Border color changed to the new Blue */
        }
        
        /* NEW: Error style for inputs */
        input.error {
            border-color: #EF4444 !important; /* Red color */
            border-width: 2px;
        }

        /* Base Generate Button Style (CHANGED TO GREEN) */
        #generate-btn {
            background-color: #4CAF50; /* CHANGED: Green */
            color: #1a1a2e;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            width: 100%;
            transition: background-color 0.2s;
        }
        #generate-btn:hover {
            background-color: #388E3C; /* Darker Green on hover */
        }
        
        /* MODIFIED: Save Button style to match the new image (Green) */
        #save-api-key-btn {
            background-color: #4CAF50; /* Green (Matching the first image's button) */
            color: #1a1a2e;
            font-weight: 700;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-size: 1.25rem;
            transition: background-color 0.2s;
        }
        #save-api-key-btn:hover {
            background-color: #388E3C; /* Darker Green on hover */
        }


        /* Emoji Toggle Button Styles */
        #emoji-toggle-btn {
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
            border-radius: 0.75rem; /* Match generate button */
            height: 3.4rem; /* Manually match height of generate button */
        }
        .toggle-off {
            background-color: #3f3f6e;
            color: #8888aa;
        }
        .toggle-off:hover {
            background-color: #555588;
        }
        /* CHANGED: Pink for ON state */
        .toggle-on {
            background-color: #EC4899; /* CHANGED: Pink */
            color: #1a1a2e;
            font-weight: 700;
        }
        .toggle-on:hover {
            background-color: #DB2777; /* Darker Pink on hover */
        }

        .action-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
            white-space: nowrap; /* Prevent text wrap */
        }
        .action-button#copy-btn, .action-button#copy-headline-btn, .action-button#copy-hashtag-btn {
            background-color: #555588 !important;
            color: #e5e5f7 !important;
        }
        .action-button#copy-btn:hover, .action-button#copy-headline-btn:hover, .action-button#copy-hashtag-btn:hover {
            background-color: #6a6a99 !important;
        }
        /* CHANGED: Regenerate to Orange */
        #regenerate-btn {
            background-color: #F97316; /* CHANGED: Orange */
            color: #1a1a2e;
        }
        #regenerate-btn:hover {
            background-color: #EA580C; /* Darker Orange */
        }
        /* CHANGED: Headline to Green */
        #headline-btn {
            background-color: #4CAF50; /* CHANGED: Green */
            color: #1a1a2e;
        }
        #headline-btn:hover {
            background-color: #388E3C;
        }
        /* CHANGED: Hashtag button to Dark Blue */
        #hashtag-btn {
            background-color: #1D4ED8; /* CHANGED: Dark Blue */
            color: #FFFFFF;
        }
        #hashtag-btn:hover {
            background-color: #1E40AF; /* Darker Blue on hover */
        }
        /* Reference Toggle Button Styles */
        #toggle-reference-btn {
            background-color: #4CAF50; /* Green for add */
            color: #1a1a2e;
        }
        #toggle-reference-btn:hover {
            background-color: #388E3C;
        }
        #toggle-reference-btn.active {
            background-color: #dc2626; /* Red for hide/remove */
            color: #e5e5f7;
        }
        #toggle-reference-btn.active:hover {
            background-color: #b91c1c;
        }

        .spinner {
            /* Spinner color uses the new Light Blue */
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #42A5F5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Custom yellow text for dual hashtag output titles */
        .text-custom-yellow {
            color: #FCA311;
        }

        /* Ensure markdown output uses dark background colors for lists/blocks */
        #idea-output {
            line-height: 1.6;
        }
        #idea-output pre, #idea-output code {
            background-color: #1a1a2e;
            padding: 0.5rem;
            border-radius: 0.25rem;
            overflow-x: auto;
        }
        #idea-output ul {
            padding-left: 1.5rem;
            list-style-type: disc;
        }
        #idea-output ol {
            padding-left: 1.5rem;
            list-style-type: decimal;
        }
        
        /* Custom styling to place the eye icon for password input */
        .password-input-container {
            position: relative;
        }
        .toggle-password-visibility {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #8888aa; /* Eye icon color */
            padding: 0.25rem;
        }
        .toggle-password-visibility:hover {
            color: #e5e5f7;
        }
    </style>
</head>
<body>

<!-- API Key Modal (RESTORED PASSWORD INPUT) -->
<div id="api-key-modal" class="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-50 p-4">
    <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-md">
        <!-- MODIFIED: Header to include password reference -->
        <div class="text-center mb-6">
            <p class="text-lg sm:text-xl font-medium text-gray-400">
                <span style="color: #4CAF50;">&#9999; Digimetric</span>
            </p>
            <h1 class="text-2xl sm:text-3xl font-bold mb-4">Content Idea Generator</h1>
            <!-- MODIFIED: Text changed to include password -->
            <h2 class="text-xl font-bold mb-4">Gemini API Key & Password ဖြင့် Log in ဝင်ရောက်ရန်</h2>
            <!-- MODIFIED: Text changed to include password -->
            <p class="text-gray-400 text-sm">App အသီးသီး ပြုလုပ်ရန်အတွက် **Gemini API Key** နှင့် **Password** ကို ထည့်သွင်းပါ။</p>
        </div>

        <p class="text-xs text-gray-500 mt-4 text-center">API Key ကို Google AI Studio တွင် အခမဲ့ ရယူနိုင်ပါသည်။</p>

        <!-- API KEY INPUT -->
        <div class="input-group">
            <label for="api-key-input" class="selector-label text-base">Gemini API Key ထည့်သွင်းရန်</label>
            <input type="password" id="api-key-input" placeholder="API Key ထည့်သွင်းပါ">
            <p id="api-key-error" class="text-red-400 text-sm mt-2 hidden"></p>
        </div>
        
        <!-- MODIFIED: Password Input Field (Removed password-error paragraph) -->
        <div class="input-group">
            <label for="password-input-field" class="selector-label text-base">Password ထည့်သွင်းရန်</label>
            <div class="password-input-container">
                <input type="password" id="password-input-field" placeholder="Password ထည့်သွင်းပါ">
                <span class="toggle-password-visibility" data-target="password-input-field">
                    <!-- Eye icon (initial state is hidden) -->
                    👁️
                </span>
            </div>
            <!-- NOTE: The error message element (password-error) has been removed as requested -->
        </div>

        <!-- MODIFIED: Button text changed to "Log in" -->
        <button id="save-api-key-btn" class="w-full font-bold py-3 px-4 rounded-lg">Log in</button>
    </div>
</div>


<div class="card p-6 lg:p-10 hidden">
    <!-- MODIFIED: Title Structure - Digimetric is now on top -->
    <div class="text-center mb-8 relative">
        <p class="text-lg sm:text-xl font-medium text-gray-400">Digimetric</p>
        <h1 class="text-2xl sm:text-3xl font-bold">AI-Powered Content Idea Generator</h1>
        <button id="change-api-key-btn" class="absolute top-0 right-0 text-xs bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-2 rounded transition-colors">Change Key</button>
    </div>

    <!-- Topic Input -->
    <div class="input-group">
        <label for="topic-input" class="selector-label">
            What topic do you need content ideas for?
            <span class="text-sm text-gray-400 block">(e.g., Restaurant Business, Plumbing Services, Software Sales)</span>
        </label>
        <textarea id="topic-input" rows="3" placeholder="Enter your business type or specific content theme..." required></textarea>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">

        <!-- Platforms (Now Single Select with Brand Colors) -->
        <div class="input-group">
            <span class="selector-label">Platform</span>
            <div id="platform-selector" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <div class="selection-button" data-value="Facebook" data-type="single">Facebook</div>
                <div class="selection-button" data-value="Instagram" data-type="single">Instagram</div>
                <div class="selection-button" data-value="Twitter" data-type="single">Twitter/X</div>
                <div class="selection-button" data-value="YouTube" data-type="single">YouTube</div>
                <div class="selection-button" data-value="TikTok" data-type="single">TikTok</div>
                <div class="selection-button" data-value="LinkedIn" data-type="single">LinkedIn</div>
                <div class="selection-button" data-value="Website" data-type="single">Website</div>
            </div>
        </div>

        <!-- Content Types -->
        <div class="input-group">
            <span class="selector-label">Content Type</span>
            <div id="contentType-selector" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <div class="selection-button" data-value="Social Media Post" data-type="single">Social Media</div>
                <div class="selection-button selected" data-value="Blog Post" data-type="single">Blog Post</div> 
                <div class="selection-button" data-value="Podcast" data-type="single">Podcast</div>
                <div class="selection-button" data-value="Newsletter" data-type="single">Newsletter</div>
                <div class="selection-button" data-value="Infographic" data-type="single">Infographic</div>
                <div class="selection-button" data-value="Script/Outline" data-type="single">Script</div>
            </div>
        </div>
        
        <!-- Choose Output Level -->
        <div class="input-group">
            <span class="selector-label">Choose Output Level</span>
            <div id="outputLevel-selector" class="flex gap-3">
                <div class="selection-button" data-value="Rough" data-type="single">Rough Idea</div>
                <div class="selection-button selected" data-value="Short" data-type="single">Short to the point</div>
                <div class="selection-button" data-value="Detailed" data-type="single">Detailed with Info</div>
            </div>
        </div>

        <!-- Target Audience (optional) -->
        <div class="input-group">
            <span class="selector-label">Target Audience (optional)</span>
            <input id="audience-input" type="text" placeholder="e.g., Business Owners, Entrepreneurs, Investors">
        </div>

        <!-- Select Language -->
        <div class="input-group">
            <span class="selector-label">Select Language</span>
            <div id="language-selector" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <div class="selection-button selected" data-value="English" data-type="single">English</div>
                <div class="selection-button" data-value="Myanmar (Burmese)" data-type="single">Myanmar</div> 
                <div class="selection-button" data-value="Thai" data-type="single">Thailand</div>
                <div class="selection-button" data-value="Chinese" data-type="single">Chinese</div>
                <div class="selection-button" data-value="Tagalog (Philippine)" data-type="single">Philippine</div>
                <div class="selection-button" data-value="Indonesian" data-type="single">Indonesia</div>
            </div>
        </div>

        <!-- Tone/Style -->
        <div class="input-group">
            <span class="selector-label">Tone/Style</span>
            <div id="tone-selector" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <!-- MODIFIED: Changed label from 'Sales Copy' to 'Sales' and data-value from 'Sales-Driven' to 'Sales' -->
                <div class="selection-button" data-value="Sales" data-type="single">Sales</div> 
                <div class="selection-button" data-value="Professional" data-type="single">Professional</div>
                <div class="selection-button" data-value="Motivational" data-type="single">Motivational</div>
                <div class="selection-button" data-value="Informational" data-type="single">Informational</div>
                <div class="selection-button selected" data-value="Emotional" data-type="single">Emotional</div> 
                <div class="selection-button" data-value="Storytelling" data-type="single">Storytelling</div>
                <div class="selection-button" data-value="Business Perspective" data-type="single">Business Perspective</div>
            </div>
        </div>

    </div>
    
    <!-- New: Reference URL Input Area (Placed above Generate Button) -->
    <div class="mt-6 input-group">
        <div class="flex justify-between items-center mb-3">
            <span class="selector-label mb-0">Reference URLs (optional)</span>
            <button id="toggle-reference-btn" class="action-button">
                + Add Reference URL
            </button>
        </div>
        <div id="reference-url-container" class="hidden">
            <textarea id="reference-url-input" rows="3" placeholder="Paste one or more reference links here, separated by newlines or commas. The AI will use this information as context."></textarea>
            <p class="text-xs text-gray-400 mt-2">The AI will read the content of these links for context, in addition to using Google Search.</p>
        </div>
    </div>


    <!-- Generate Button and Emoji Toggle -->
    <div class="mt-8 flex gap-4 items-stretch">
        <button id="generate-btn" class="flex-grow">
            Generate Ideas
        </button>
        <!-- New Emoji Toggle Button -->
        <button id="emoji-toggle-btn" 
                class="flex-shrink-0 w-16 text-2xl flex items-center justify-center toggle-off" 
                title="Emoji Off (အီမိုဂျီ ပိတ်ထားသည်)">
            🚫
        </button>
    </div>

    <!-- Results Container (Main Idea) -->
    <div id="results-container" class="hidden mt-8">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
            <h2 id="idea-title" class="text-xl font-semibold flex-shrink-0">Generated Content Idea</h2>
            <!-- Action Buttons for Idea (Copy and Regenerate) -->
            <div class="flex flex-wrap justify-start sm:justify-end gap-3 w-full sm:w-auto">
                <button id="copy-btn" class="action-button hidden">
                    Copy
                </button>
                <button id="regenerate-btn" class="action-button hidden">
                    Regenerate Idea
                </button>
            </div>
        </div>
        
        <div id="loading-indicator" class="flex justify-center items-center py-8 hidden">
            <div class="spinner mr-3"></div>
            <span class="text-lg">Generating Content Idea...</span>
        </div>
        <div id="idea-output" class="text-sm whitespace-pre-wrap"></div>
        <!-- Source Output Container - Hide entirely if no sources are found -->
        <div id="sources-output" class="mt-4 pt-4 border-t border-gray-600 border-dashed text-xs text-gray-400 hidden"></div>
        
        <!-- Secondary Action Buttons (Moved to the bottom, updated text) -->
        <div class="mt-6 pt-4 border-t border-gray-600 border-dashed flex flex-col sm:flex-row flex-wrap items-center justify-center gap-4">
            <button id="headline-btn" class="action-button hidden w-full sm:w-auto">
                Generate Headline Ideas
            </button>
            <button id="hashtag-btn" class="action-button hidden w-full sm:w-auto">
                Trending Hashtag Ideas
            </button>
        </div>
    </div>
    
    <!-- Headline Results Container -->
    <div id="headline-results-container" class="hidden mt-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Generated Headline Ideas</h2>
            <button id="copy-headline-btn" class="action-button hidden">
                Copy
            </button>
        </div>
        <div id="headline-loading-indicator" class="flex justify-center items-center py-8 hidden">
            <div class="spinner mr-3"></div>
            <span class="text-lg">Generating Headlines...</span>
        </div>
        <div id="headline-output" class="text-sm whitespace-pre-wrap"></div>
    </div>

    <!-- Hashtag Results Container (Updated for Dual Output) -->
    <div id="hashtag-results-container" class="hidden mt-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Trending Hashtag Ideas</h2>
            <button id="copy-hashtag-btn" class="action-button hidden">
                Copy
            </button>
        </div>
        <div id="hashtag-loading-indicator" class="flex justify-center items-center py-8 hidden">
            <div class="spinner mr-3"></div>
            <span class="text-lg">Generating Trending Hashtags...</span>
        </div>
        
        <!-- DUAL LANGUAGE OUTPUT BOXES (For Myanmar Language) -->
        <div id="dual-hashtag-output" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
            <div>
                <!-- Custom yellow text for dual hashtag output titles -->
                <h3 class="font-bold text-lg text-custom-yellow mb-2">English Hashtags</h3>
                <div id="hashtag-output-en" class="text-sm whitespace-pre-wrap p-4 bg-gray-700 rounded-lg"></div>
            </div>
            <div>
                <!-- Custom yellow text for dual hashtag output titles -->
                <h3 class="font-bold text-lg text-custom-yellow mb-2">Myanmar Hashtags</h3>
                <div id="hashtag-output-mm" class="text-sm whitespace-pre-wrap p-4 bg-gray-700 rounded-lg"></div>
            </div>
        </div>
        
        <!-- SINGLE LANGUAGE OUTPUT BOX (Default) -->
        <div id="single-hashtag-output">
            <div id="hashtag-output" class="text-sm whitespace-pre-wrap"></div>
        </div>
    </div>
</div>

<script>
    // --- Helper Functions and Initial Setup ---

    // Global State for Emoji Toggle
    let isEmojiEnabled = false; 

    // Utility for exponential backoff during API calls
    const MAX_RETRIES = 7; // Increased for better robustness
    const initialDelay = 1000; // 1 second
    
    // *** Model: gemini-2.5-flash-preview-05-20 for stability and speed. ***
    const modelName = 'gemini-2.5-flash-preview-05-20'; 

    // Global variable to store the last generated content idea for secondary generation
    let lastGeneratedContentIdea = "";
    
    // --- Password Validation Logic (MODIFIED to check for digits) ---
    /**
     * Custom password validation for the app.
     * Password must be lexicographically between "digicig0251" and "digicig0800".
     * It must also start with 'digicig' and end with exactly 4 digits.
     */
    function checkPasswordRange(password) {
        if (!password) return false;

        // 1. Check format: starts with 'digicig' and ends with 4 digits
        const regex = /^digicig(\d{4})$/;
        const match = password.match(regex);
        
        if (!match) return false;

        // 2. Check value against the range (lexicographically, as required)
        const minPass = "digicig0251";
        const maxPass = "digicig0800";
        
        return password >= minPass && password <= maxPass;
    }

    // --- Password Visibility Toggle Logic (RESTORED) ---
    document.addEventListener('DOMContentLoaded', () => {
        // Set up password visibility toggles
        document.querySelectorAll('.toggle-password-visibility').forEach(toggle => {
            toggle.addEventListener('click', (event) => {
                const targetId = event.currentTarget.dataset.target;
                const targetInput = document.getElementById(targetId);
                
                if (targetInput.type === 'password') {
                    targetInput.type = 'text';
                    event.currentTarget.textContent = '🔒'; // Lock icon for visibility
                    event.currentTarget.title = 'Hide password';
                } else {
                    targetInput.type = 'password';
                    event.currentTarget.textContent = '👁️'; // Eye icon for hidden
                    event.currentTarget.title = 'Show password';
                }
            });
            // Initial icon setting (done in HTML for the first element, ensuring it's set for all)
            if (toggle.dataset.target === 'password-input-field') {
                toggle.textContent = '👁️';
            }
        });
    });


    // --- API Key Management & Initialization (MODIFIED TO RE-INCLUDE PASSWORD) ---
    document.addEventListener('DOMContentLoaded', () => {
        const apiKeyModal = document.getElementById('api-key-modal');
        const mainCard = document.querySelector('.card');
        const apiKeyInput = document.getElementById('api-key-input');
        const passwordInputField = document.getElementById('password-input-field'); // MODIFIED ID
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const changeApiKeyBtn = document.getElementById('change-api-key-btn');
        const apiKeyError = document.getElementById('api-key-error');

        function initializeApp() {
            // Check if both API Key and Password are present for login
            const userApiKey = localStorage.getItem('geminiApiKey');
            const userPassword = localStorage.getItem('appPassword'); 
            
            if (userApiKey && userPassword) { // Check both
                apiKeyModal.classList.add('hidden');
                mainCard.classList.remove('hidden');
            } else {
                apiKeyModal.classList.remove('hidden');
                mainCard.classList.add('hidden');
            }
        }

        saveApiKeyBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            const password = passwordInputField.value.trim(); // Use new ID
            
            // Clear previous errors/borders
            apiKeyInput.classList.remove('error');
            passwordInputField.classList.remove('error'); // Clear password error border
            apiKeyError.classList.add('hidden'); 

            let isValid = true;

            // 1. Validate API Key (must be provided and reasonable length)
            if (!key || key.length <= 10) {
                apiKeyError.textContent = 'API Key ထည့်သွင်းရန် လိုအပ်ပါသည်။ (Please enter a valid API key.)';
                apiKeyError.classList.remove('hidden');
                apiKeyInput.classList.add('error');
                isValid = false;
            } 
            
            // 2. Validate Password against the custom range (MODIFIED: ONLY ADD ERROR CLASS, NO TEXT)
            if (!password || !checkPasswordRange(password)) {
                passwordInputField.classList.add('error'); // Add error border
                isValid = false;
            }
            
            if (!isValid) {
                return;
            }

            // If validation passes:
            localStorage.setItem('geminiApiKey', key);
            localStorage.setItem('appPassword', password); 
            initializeApp();
        });

        changeApiKeyBtn.addEventListener('click', () => {
            localStorage.removeItem('geminiApiKey');
            localStorage.removeItem('appPassword'); 
            apiKeyInput.value = ''; 
            passwordInputField.value = ''; // Clear the password field too
            apiKeyInput.classList.remove('error'); // Clear error state on input
            passwordInputField.classList.remove('error'); // Clear error state on password
            initializeApp();
        });

        // Initial check on page load
        initializeApp();
    });

    /**
     * Converts a markdown list of sources to an HTML string.
     */
    function formatSources(sources) {
        if (!sources || sources.length === 0) return '';

        let html = '<strong>Up-to-date Information Sources:</strong><ul>';
        sources.forEach(source => {
            html += `<li><a href="${source.uri}" target="_blank" class="text-blue-400 hover:text-blue-300 transition">${source.title || source.uri}</a></li>`;
        });
        html += '</ul>';
        return html;
    }

    /**
     * Calls the Gemini API with exponential backoff.
     */
    async function callGeminiApi(payload, retries = 0) {
        const userApiKey = localStorage.getItem('geminiApiKey');
        if (!userApiKey) {
            throw new Error("Gemini API Key not found. Please set your key. (API Key မတွေ့ပါ။)");
        }
        const apiKey = userApiKey; // Use the stored key
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

        if (retries >= MAX_RETRIES) {
            // Updated error message to be more explicit about retry failure
            throw new Error("API call failed after reaching maximum retries. This might be due to temporary server load or a network issue.");
        }

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                if (response.status === 429 || response.status >= 500) {
                    const delay = initialDelay * Math.pow(2, retries);
                    console.warn(`Attempt ${retries + 1} failed with status ${response.status}. Retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return callGeminiApi(payload, retries + 1);
                }
                const errorBody = await response.text();
                throw new Error(`API returned status ${response.status}: ${errorBody}`);
            }

            return await response.json();
        } catch (error) {
            if (retries < MAX_RETRIES) {
                const delay = initialDelay * Math.pow(2, retries);
                console.warn(`Network error on attempt ${retries + 1}. Retrying in ${delay}ms...`, error);
                await new Promise(resolve => setTimeout(resolve, delay));
                return callGeminiApi(payload, retries + 1);
            }
            throw error;
        }
    }


    // --- UI Logic: Toggling Selection Buttons & Input Gathering ---

    // Define platform brand colors for selection styling
    const platformColors = {
        "Facebook": { bg: "#1877F2", text: "#FFFFFF", border: "transparent" }, // Facebook Blue
        "Instagram": { bg: "#9966CC", text: "#FFFFFF", border: "transparent" }, // Light Purple
        "Twitter": { bg: "#6B7280", text: "#FFFFFF", border: "transparent" }, // Grey
        "YouTube": { bg: "#FF0000", text: "#FFFFFF", border: "transparent" }, // YouTube Red
        "TikTok": { bg: "#000000", text: "#E5E5F7", border: "#E5E5F7" }, // Black
        "LinkedIn": { bg: "#0A66C2", text: "#FFFFFF", border: "transparent" }, // LinkedIn Blue
        "Website": { bg: "#4CAF50", text: "#1a1a2e", border: "#4CAF50" } // Green
    };
    
    // Platform selector logic (handles dynamic colors)
    const platformSelector = document.getElementById('platform-selector');
    
    platformSelector.addEventListener('click', (event) => {
        const button = event.target.closest('.selection-button');
        if (!button || !platformSelector.contains(button)) return;

        // Deselect all and reset styles
        platformSelector.querySelectorAll('.selection-button').forEach(btn => {
            btn.classList.remove('selected');
            btn.style.backgroundColor = '';
            btn.style.color = '';
            btn.style.border = '2px solid transparent';
            btn.style.fontWeight = '400'; // Reset font weight
        });

        // Select the clicked button and apply brand color
        button.classList.add('selected');
        const platform = button.dataset.value;
        const color = platformColors[platform];
        if (color) {
            button.style.backgroundColor = color.bg;
            button.style.color = color.text;
            button.style.border = `2px solid ${color.border}`;
            button.style.fontWeight = '600'; // Set font weight
        } else {
             // Fallback to default selected style if color map is missing
            button.style.backgroundColor = '#42A5F5'; // New Blue
            button.style.color = '#1a1a2e';
            button.style.fontWeight = '600';
        }
    });

    // Other selectors (standard blue selection)
    const selectors = ['contentType', 'outputLevel', 'language', 'tone'];
    
    selectors.forEach(id => {
        const container = document.getElementById(`${id}-selector`);
        if (container) {
            container.addEventListener('click', (event) => {
                const button = event.target.closest('.selection-button');
                if (!button || !container.contains(button)) return;

                const type = button.dataset.type;

                if (type === 'single') {
                    container.querySelectorAll('.selection-button').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    button.classList.add('selected');
                } else if (type === 'multi') {
                    button.classList.toggle('selected');
                }
            });
        }
    });

    /**
     * Gathers all selected values from a selector container.
     */
    function getSelectedValues(id) {
        const container = document.getElementById(`${id}-selector`);
        if (!container) return '';
        
        const selectedButtons = container.querySelectorAll('.selection-button.selected');
        
        return Array.from(selectedButtons)
                    .map(btn => btn.dataset.value)
                    .join(', ');
    }

    // --- Emoji Toggle Logic ---
    const emojiToggleBtn = document.getElementById('emoji-toggle-btn');
    
    // Initial state setup (using CSS classes defined in <style>)
    emojiToggleBtn.classList.add('toggle-off');

    emojiToggleBtn.addEventListener('click', () => {
        isEmojiEnabled = !isEmojiEnabled;
        if (isEmojiEnabled) {
            emojiToggleBtn.textContent = '😊';
            emojiToggleBtn.classList.remove('toggle-off');
            emojiToggleBtn.classList.add('toggle-on');
            emojiToggleBtn.title = 'Emoji On (အီမိုဂျီ ဖွင့်ထားသည်)';
        } else {
            emojiToggleBtn.textContent = '🚫';
            emojiToggleBtn.classList.remove('toggle-on');
            emojiToggleBtn.classList.add('toggle-off');
            emojiToggleBtn.title = 'Emoji Off (အီမိုဂျီ ပိတ်ထားသည်)';
        }
    });
    
    // --- New: Reference URL Toggle Logic ---
    const toggleReferenceBtn = document.getElementById('toggle-reference-btn');
    const referenceUrlContainer = document.getElementById('reference-url-container');
    const referenceUrlInput = document.getElementById('reference-url-input');
    let isUrlInputVisible = false;

    // Set initial button text and class
    toggleReferenceBtn.textContent = '+ Add Reference URL';

    // Toggle Logic for Reference URL Input
    toggleReferenceBtn.addEventListener('click', () => {
        isUrlInputVisible = !isUrlInputVisible;
        referenceUrlContainer.classList.toggle('hidden', !isUrlInputVisible);
        
        if (isUrlInputVisible) {
            toggleReferenceBtn.textContent = '- Hide Reference URL';
            toggleReferenceBtn.classList.add('active'); // Use active class for styling
        } else {
            toggleReferenceBtn.textContent = '+ Add Reference URL';
            toggleReferenceBtn.classList.remove('active');
        }
    });

    // --- Copy Functionality (FIXED FOR iFRAME COMPATIBILITY) ---
    const copyBtn = document.getElementById('copy-btn');
    const ideaOutput = document.getElementById('idea-output');
    const regenerateBtn = document.getElementById('regenerate-btn');
    const headlineBtn = document.getElementById('headline-btn');
    const hashtagBtn = document.getElementById('hashtag-btn');

    const headlineOutput = document.getElementById('headline-output');
    const headlineResultsContainer = document.getElementById('headline-results-container');
    const copyHeadlineBtn = document.getElementById('copy-headline-btn');

    // Hashtag related elements
    const hashtagOutput = document.getElementById('hashtag-output');
    const hashtagOutputEn = document.getElementById('hashtag-output-en');
    const hashtagOutputMm = document.getElementById('hashtag-output-mm');
    const hashtagResultsContainer = document.getElementById('hashtag-results-container');
    const copyHashtagBtn = document.getElementById('copy-hashtag-btn');


    /**
     * Reusable copy logic for any element/object, using document.execCommand for iFrame compatibility.
     * @param {HTMLElement | {text: string}} targetElement - The element or object containing the text content to copy.
     * @param {HTMLElement} buttonElement - The button element for visual feedback.
     */
    async function copyContent(targetElement, buttonElement) {
        // 1. Determine the raw text to copy
        // If it's an HTML element, use textContent.
        // If it's the custom object for dual copy, use the 'text' property.
        const rawText = targetElement.textContent || (targetElement.text || '');
        const textToCopy = rawText.trim(); 
        
        if (!textToCopy) return;

        const originalText = buttonElement.textContent;
        const originalBg = buttonElement.style.backgroundColor;
        const originalColor = buttonElement.style.color;
        const successBg = '#10B981'; // Emerald Green
        const successColor = '#1a1a2e';
        
        // Use document.execCommand('copy') for better compatibility in iFrame environments.
        let success = false;
        const textarea = document.createElement('textarea');
        textarea.value = textToCopy;
        // Make the textarea invisible and outside the viewport
        textarea.style.position = 'fixed';
        textarea.style.top = '0';
        textarea.style.left = '0';
        textarea.style.opacity = '0';
        
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();

        try {
            // Deprecated but reliable in restricted environments like iFrames.
            success = document.execCommand('copy');
        } catch (err) {
            console.error('Copy failed:', err);
            success = false;
        } finally {
            document.body.removeChild(textarea);
        }

        // Visual feedback
        if (success) {
            buttonElement.textContent = 'Copied! 🎉';
            buttonElement.style.backgroundColor = successBg;
            buttonElement.style.color = successColor;
            
            setTimeout(() => {
                buttonElement.textContent = originalText;
                buttonElement.style.backgroundColor = originalBg; // Restore previous inline style
                buttonElement.style.color = originalColor;
                // Relying on the original CSS styles for default look after timeout.
            }, 2000);
        } else {
            buttonElement.textContent = 'Failed!';
            buttonElement.style.backgroundColor = '#DC2626'; // Red
            buttonElement.style.color = '#FFFFFF';
            setTimeout(() => {
                buttonElement.textContent = originalText;
                buttonElement.style.backgroundColor = originalBg;
                buttonElement.style.color = originalColor;
            }, 1000);
        }
    }


    // --- Main Generator Function ---
    async function generateContentIdea(regenerate = false) {
        const topic = document.getElementById('topic-input').value.trim();
        if (!topic) {
            // Replaced alert with console error as per instructions
            console.error("Please enter a content topic or business type."); 
            return;
        }

        // Reset previous results
        document.getElementById('idea-output').innerHTML = '';
        document.getElementById('sources-output').innerHTML = '';
        document.getElementById('results-container').classList.remove('hidden');
        document.getElementById('headline-results-container').classList.add('hidden');
        document.getElementById('hashtag-results-container').classList.add('hidden');
        document.getElementById('loading-indicator').classList.remove('hidden');
        document.getElementById('generate-btn').disabled = true;
        document.getElementById('generate-btn').innerHTML = '<div class="spinner mx-auto"></div>';

        // Hide action buttons initially
        copyBtn.classList.add('hidden');
        regenerateBtn.classList.add('hidden');
        headlineBtn.classList.add('hidden');
        hashtagBtn.classList.add('hidden');


        // Gather input parameters
        const platform = getSelectedValues('platform');
        const contentType = getSelectedValues('contentType');
        const outputLevel = getSelectedValues('outputLevel');
        const language = getSelectedValues('language');
        const tone = getSelectedValues('tone'); // e.g., 'Sales', 'Professional', 'Emotional'
        const audience = document.getElementById('audience-input').value.trim();
        // Split URLs by newline, comma, or semicolon and filter out empty strings
        const referenceUrls = referenceUrlInput.value.trim().split(/[\n,;]+/).map(url => url.trim()).filter(url => url.length > 0);

        // --- NEW LOGIC: Determine word limit based on outputLevel (UPDATED AS PER USER REQUEST) ---
        let wordLimit = 300; // Default to 'Short' (UPDATED from 200 to 300)
        if (outputLevel === 'Rough') {
            wordLimit = 150; // UPDATED from 100 to 150
        } else if (outputLevel === 'Detailed') {
            wordLimit = 500; // UPDATED from 350 to 500
        }
        
        // --- NEW LOGIC: Customize Tone Description based on user request ---
        let specificToneDescription = tone;
        if (tone === 'Sales') {
            // ပေါ့ပေါ့ပါးပါးအရောင်းကြော်ငြာပုံစံရေးပေးပါ
            specificToneDescription = "a light, casual, and friendly sales advertisement style";
        } else if (tone === 'Professional') {
            // ထိရောက်ပြီး ဆွဲဆောင်မှုရှိတဲ့ အရောင်းကြော်ငြာပုံစံရေးပေးပါ
            specificToneDescription = "an effective, attractive, and professional sales advertisement style";
        } 
        
        // System Instruction Construction
        const systemPromptParts = [
            `You are Digimetric AI, a world-class content strategist and copywriter.`,
            `Your task is to generate a single, compelling content idea based on the user's brief.`,
            `The output should be formatted using Markdown (with bolding, lists, and headings) for readability.`,
            `The response length MUST be approximately ${wordLimit} words. Do NOT exceed this limit significantly.`, 
            `Do NOT include introductory phrases like "Here is your idea" or concluding remarks.`,
            `Ensure the output is delivered strictly in the requested language: ${language}.`,
            // Use the customized tone description here
            `Tone: ${specificToneDescription}.`, 
            `Output Level: ${outputLevel}.`,
        ];
        if (isEmojiEnabled) {
            systemPromptParts.push(`MUST use relevant emojis liberally to make the content lively and engaging.`);
        } else {
            systemPromptParts.push(`MUST NOT use any emojis in the output.`);
        }
        
        // --- NEW LOGIC: Add question mark instruction for Burmese language ---
        if (language === 'Myanmar (Burmese)') {
            systemPromptParts.push(`For any sentences ending with the Burmese question words "လား" or "လဲ", you MUST append a question mark (?) immediately after the word, e.g., "လုပ်မလား?" or "သွားမလဲ?".`);
        }


        // User Query Construction
        const userQueryParts = [
            `Generate a content idea for the following brief:`,
            `- **Topic/Business**: ${topic}`,
            `- **Platform**: ${platform || 'General Content Platform'}`,
            `- **Content Type**: ${contentType}`,
        ];
        if (audience) {
            userQueryParts.push(`- **Target Audience**: ${audience}`);
        }
        if (referenceUrls.length > 0) {
            // Include reference URLs in the prompt for context
            userQueryParts.push(`- **Reference Context URLs (read and summarize key info)**: ${referenceUrls.join(', ')}`);
        }

        const systemInstruction = systemPromptParts.join(' ');
        const userQuery = userQueryParts.join('\n');

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            // Use Google Search grounding for up-to-date context
            tools: [{ "google_search": {} }],
            systemInstruction: {
                parts: [{ text: systemInstruction }]
            },
        };

        try {
            const result = await callGeminiApi(payload);
            const candidate = result.candidates?.[0];
            let rawText = "Error: Failed to generate content.";
            let sources = [];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                rawText = candidate.content.parts[0].text;
                lastGeneratedContentIdea = rawText; // Save for secondary actions

                // 2. Extract grounding sources
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                // 3. Render Markdown and sanitize
                const renderedHtml = DOMPurify.sanitize(marked.parse(rawText));
                ideaOutput.innerHTML = renderedHtml;

                // 4. Display sources if available
                if (sources.length > 0) {
                    document.getElementById('sources-output').innerHTML = formatSources(sources);
                    document.getElementById('sources-output').classList.remove('hidden');
                } else {
                    document.getElementById('sources-output').classList.add('hidden');
                }

                // 5. Show action buttons
                copyBtn.classList.remove('hidden');
                regenerateBtn.classList.remove('hidden');
                headlineBtn.classList.remove('hidden');
                hashtagBtn.classList.remove('hidden');

            } else {
                ideaOutput.textContent = "Error: Received an empty or unexpected response from the AI.";
            }

        } catch (error) {
            console.error("Content Generation Error:", error);
            ideaOutput.innerHTML = `<p class="text-red-400">An error occurred: ${error.message || 'Check console for details.'}</p>`;
        } finally {
            document.getElementById('loading-indicator').classList.add('hidden');
            document.getElementById('generate-btn').disabled = false;
            document.getElementById('generate-btn').textContent = regenerate ? 'Regenerate Idea' : 'Generate Ideas';
        }
    }


    // --- Secondary Generator Function (Headlines & Hashtags) ---
    async function generateSecondaryContent(type) {
        if (!lastGeneratedContentIdea) {
            // Replaced alert with console error as per instructions
            console.error("Please generate a main content idea first.");
            return;
        }

        const isHeadline = type === 'headline';
        const isHashtag = type === 'hashtag';
        const language = getSelectedValues('language');
        const isMyanmar = language === 'Myanmar (Burmese)';

        const resultsContainer = isHeadline ? headlineResultsContainer : hashtagResultsContainer;
        const outputElement = isHeadline ? headlineOutput : hashtagOutput;
        const loadingIndicator = isHeadline ? document.getElementById('headline-loading-indicator') : document.getElementById('hashtag-loading-indicator');
        const copyButton = isHeadline ? copyHeadlineBtn : copyHashtagBtn;
        
        // Specific elements for dual output
        const singleHashtagContainer = document.getElementById('single-hashtag-output');
        const dualHashtagContainer = document.getElementById('dual-hashtag-output');
        
        // Setup UI
        resultsContainer.classList.remove('hidden');
        loadingIndicator.classList.remove('hidden');
        outputElement.innerHTML = '';
        copyButton.classList.add('hidden');
        if (isHashtag) {
            singleHashtagContainer.classList.remove('hidden');
            dualHashtagContainer.classList.add('hidden');
            hashtagOutputEn.textContent = '';
            hashtagOutputMm.textContent = '';
        }

        let systemInstruction;
        let userQuery;
        
        // --- NEW LOGIC: Add question mark instruction for Burmese language (Headlines) ---
        let questionMarkInstruction = "";
        if (isHeadline && isMyanmar) {
             questionMarkInstruction = `For any headline ending with the Burmese question words "လား" or "လဲ", you MUST append a question mark (?) immediately after the word, e.g., "ဘာကြောင့်ဒီလိုဖြစ်တာလဲ?".`;
        }

        if (isHeadline) {
            systemInstruction = `You are a professional copywriter. Your task is to create 10 highly engaging and clickable headlines (titles) for the following content idea. The headlines should be formatted as a numbered list in Markdown. Deliver the output strictly in the requested language: ${language}. ${isEmojiEnabled ? 'Use emojis.' : 'Do NOT use emojis.'} ${questionMarkInstruction}`;
            userQuery = `Content Idea to generate headlines for:\n\n---\n${lastGeneratedContentIdea}`;
        } else if (isHashtag) {
            if (isMyanmar) {
                // Request structured text for dual output
                systemInstruction = `You are a social media trend expert. Your task is to generate trending and relevant hashtags for the following content idea. You MUST provide TWO distinct lists: one for English hashtags and one for Myanmar (Burmese) hashtags. Format the output strictly as follows: 
                ENGLISH_HASHTAGS: #hashtag1 #hashtag2 #hashtag3...
                MYANMAR_HASHTAGS: #မြန်မာtag1 #မြန်မာtag2 #မြန်မာtag3...
                DO NOT include any other text, explanation, or introduction besides the two sections and the hashtags themselves.`;
                userQuery = `Content Idea to generate trending hashtags for:\n\n---\n${lastGeneratedContentIdea}`;
            } else {
                // Single language output
                systemInstruction = `You are a social media trend expert. Your task is to generate 20 trending and highly relevant hashtags for the following content idea. The hashtags must be delivered strictly in the requested language: ${language}. The output MUST be a single line of text with all hashtags separated by a space, beginning with the '#' symbol for each tag. DO NOT include any lists, numbers, or other text.`;
                userQuery = `Content Idea to generate trending hashtags for:\n\n---\n${lastGeneratedContentIdea}`;
            }
        }

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            tools: [{ "google_search": {} }],
            systemInstruction: {
                parts: [{ text: systemInstruction }]
            },
        };

        try {
            const result = await callGeminiApi(payload);
            const rawText = result.candidates?.[0]?.content?.parts?.[0]?.text || '';
            
            if (!rawText) {
                outputElement.textContent = `Error: Received an empty response from the AI for ${type}.`;
                return;
            }

            if (isHashtag && isMyanmar) {
                // Handle Dual Hashtag Output
                const enMatch = rawText.match(/ENGLISH_HASHTAGS\s*:\s*([\s\S]*?)(?:\r?\n|\r)MYANMAR_HASHTAGS/i);
                const mmMatch = rawText.match(/MYANMAR_HASHTAGS\s*:\s*([\s\S]*)/i);

                let enHashtags = 'Could not parse English hashtags.';
                let mmHashtags = 'Could not parse Myanmar hashtags.';

                if (enMatch && enMatch[1]) {
                    enHashtags = enMatch[1].trim();
                }
                if (mmMatch && mmMatch[1]) {
                    mmHashtags = mmMatch[1].trim();
                }

                if (enMatch || mmMatch) {
                    hashtagOutputEn.textContent = enHashtags;
                    hashtagOutputMm.textContent = mmHashtags;
                    singleHashtagContainer.classList.add('hidden');
                    dualHashtagContainer.classList.remove('hidden');
                    copyButton.classList.remove('hidden');
                } else {
                     // Fallback to single output display if parsing failed
                    outputElement.innerHTML = `<p class="text-red-400">Error parsing dual language output. Displaying raw response for debugging: <pre>${rawText}</pre></p>`;
                    singleHashtagContainer.classList.remove('hidden');
                    dualHashtagContainer.classList.add('hidden');
                    copyButton.classList.remove('hidden');
                }

            } else {
                // Handle Single Output (Headlines or non-Myanmar Hashtags)
                const renderedHtml = DOMPurify.sanitize(marked.parse(rawText));
                outputElement.innerHTML = renderedHtml;
                singleHashtagContainer.classList.remove('hidden');
                copyButton.classList.remove('hidden');
            }

        } catch (error) {
            console.error(`${type} Generation Error:`, error);
            outputElement.innerHTML = `<p class="text-red-400">An error occurred during ${type} generation: ${error.message || 'Check console for details.'}</p>`;
        } finally {
            loadingIndicator.classList.add('hidden');
        }
    }


    // --- Event Listeners ---

    // Primary Generation
    document.getElementById('generate-btn').addEventListener('click', () => generateContentIdea(false));
    regenerateBtn.addEventListener('click', () => generateContentIdea(true));

    // Secondary Generation
    headlineBtn.addEventListener('click', () => generateSecondaryContent('headline'));
    hashtagBtn.addEventListener('click', () => generateSecondaryContent('hashtag'));

    // Copy Main Idea
    copyBtn.addEventListener('click', () => {
        // Use an object to pass the raw text for the copy function
        copyContent({ text: lastGeneratedContentIdea }, copyBtn);
    });

    // Copy Headline
    copyHeadlineBtn.addEventListener('click', () => {
        // Copy the raw text from the output container
        copyContent(headlineOutput, copyHeadlineBtn);
    });
    
    // Copy Hashtags (Handles dual language structure)
    copyHashtagBtn.addEventListener('click', () => {
        const selectedLanguage = getSelectedValues('language');
        let textToCopy;
        
        if (selectedLanguage === 'Myanmar (Burmese)') {
            // Copy both English and Myanmar hashtags, separated by a line break
            const enText = hashtagOutputEn.textContent.trim();
            const mmText = hashtagOutputMm.textContent.trim();
            textToCopy = `${enText}\n${mmText}`;
        } else {
            // Copy the single language output
            textToCopy = hashtagOutput.textContent.trim();
        }

        // Use a temporary object structure for the copy function
        copyContent({ text: textToCopy }, copyHashtagBtn);
    });

</script>
</body>
</html>
